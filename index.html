<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Analizador de Dominios Sospechosos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #0f172a; color: #e2e8f0; font-family: "Inter", sans-serif; }
    th, td { padding: 0.5rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    tr:hover { background-color: rgba(255, 255, 255, 0.05); }
    .hiddenRow { display: none; }
  </style>
</head>
<body class="min-h-screen p-6">

<div class="max-w-6xl mx-auto">
  <h1 class="text-3xl font-bold mb-2 text-sky-400">üîç Analizador de Dominios Sospechosos</h1>
  <p class="text-gray-400 mb-6">Detecta dominios de phishing o abuso de marca usando RDAP, crt.sh y DNS.</p>

  <div class="bg-slate-800 rounded-2xl p-6 shadow-lg mb-6">
    <label class="block mb-2 font-semibold text-sky-300">Lista de marcas / dominios:</label>
    <textarea id="brandList" rows="4" class="w-full rounded-md p-2 bg-slate-900 border border-slate-700 resize-y" placeholder="bancsabadell.com"></textarea>

    <label class="block mt-4 mb-2 font-semibold text-sky-300">TLDs a probar:</label>
    <input id="tldList" type="text" class="w-full rounded-md p-2 bg-slate-900 border border-slate-700" value=".com,.net,.org,.es,.info"/>

    <div class="mt-5 flex items-center gap-4">
      <button id="analyzeBtn" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold px-6 py-2 rounded-lg shadow">Analizar</button>
      <button id="clearBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold px-6 py-2 rounded-lg">Limpiar</button>
    </div>

    <progress id="progressBar" value="0" max="100" class="mt-4 w-full h-3"></progress>
    <p id="statusMsg" class="text-gray-400 mt-2"></p>
  </div>

  <div id="results" class="bg-slate-800 rounded-2xl p-4 shadow overflow-x-auto max-h-[70vh]"></div>

  <footer class="text-gray-500 text-sm text-center mt-8">
    ¬© kvzlx
  </footer>
</div>

<script>
const WORKER_URL = "https://domain-analyzer-worker.gitsearch.workers.dev";

document.getElementById("analyzeBtn").addEventListener("click", analyzeDomains);
document.getElementById("clearBtn").addEventListener("click", clearAll);

async function analyzeDomains() {
  const brands = document.getElementById("brandList").value.trim().split("\n").filter(Boolean);
  const tlds = document.getElementById("tldList").value.trim();
  const resultsDiv = document.getElementById("results");
  const progress = document.getElementById("progressBar");
  const status = document.getElementById("statusMsg");

  if (!brands.length) return alert("Introduce al menos un dominio.");

  resultsDiv.innerHTML = "";
  progress.value = 0;
  status.textContent = "‚è≥ Analizando...";

  let html = `<table class="w-full text-sm"><thead><tr>
    <th>Dominio</th><th>Clasificaci√≥n</th><th>Fuente</th><th>Creaci√≥n</th><th>Expira</th><th>Registrante</th><th>√öltimo Cert.</th><th>Notas</th><th></th>
  </tr></thead><tbody>`;

  for (let i = 0; i < brands.length; i++) {
    const brand = brands[i];
    try {
      const res = await fetch(`${WORKER_URL}/?brand=${encodeURIComponent(brand)}&tlds=${encodeURIComponent(tlds)}`);
      const data = await res.json();
      if (data.encontrados && data.encontrados.length > 0) {
        data.encontrados.forEach((d, idx) => {
          const id = `${brand}_${idx}`;
          html += `<tr>
            <td>${escapeHTML(d.dominio)}</td>
            <td>${escapeHTML(d.clasificacion || "-")}</td>
            <td>${(d.fuentes || []).join(", ") || "-"}</td>
            <td>${formatDate(d.fecha_creacion)}</td>
            <td>${formatDate(d.fecha_expiracion)}</td>
            <td>${escapeHTML(d.registrante || "-")}</td>
            <td>${formatDate(d.fecha_cert_reciente)}</td>
            <td>${(d.notas || []).join(", ") || "-"}</td>
            <td><button class="text-sky-400 underline" onclick="toggleRow('${id}')">Ver</button></td>
          </tr>
          <tr id="${id}" class="hiddenRow"><td colspan="9">
            <div class="bg-slate-900 p-3 rounded-lg text-gray-300 text-xs">
              <b>IP(s):</b> ${escapeHTML((d.registros || []).join(", ")) || "-"}<br>
              <b>√öltima actualizaci√≥n RDAP:</b> ${formatDate(d.fecha_actualizacion)}<br>
              <b>Certificados detectados:</b> ${d.certificados}<br>
              <b>Notas:</b> ${(d.notas || []).join(", ") || "-"}
            </div>
          </td></tr>`;
        });
      } else {
        html += `<tr><td>${escapeHTML(brand)}</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>Sin resultados v√°lidos</td></tr>`;
      }
    } catch (err) {
      html += `<tr><td>${escapeHTML(brand)}</td><td>Error</td><td colspan="7">${escapeHTML(err.message)}</td></tr>`;
    }
    progress.value = ((i + 1) / brands.length) * 100;
  }

  html += "</tbody></table>";
  resultsDiv.innerHTML = html;
  status.textContent = "‚úÖ An√°lisis completado";
}

function toggleRow(id) {
  const row = document.getElementById(id);
  row.classList.toggle("hiddenRow");
}

function clearAll() {
  document.getElementById("brandList").value = "";
  document.getElementById("results").innerHTML = "";
  document.getElementById("progressBar").value = 0;
  document.getElementById("statusMsg").textContent = "";
}

function formatDate(dateStr) {
  if (!dateStr) return "-";
  const d = new Date(dateStr);
  return isNaN(d) ? "-" : d.toISOString().split("T")[0];
}

function escapeHTML(str) {
  return str
    ? str.replace(/[&<>'"]/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "'": "&#39;", '"': "&quot;" }[c]))
    : "";
}
</script>
</body>
</html>
